#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix DoS in mod_cache when empty Content-Type is supplied
# Origin: backport, http://svn.apache.org/viewvc?view=revision&revision=1624234

@DPATCH@
--- a/modules/cache/mod_disk_cache.c.orig	2014-10-15 11:30:14.824162491 +0200
+++ b/modules/cache/mod_disk_cache.c	2014-10-15 11:34:49.348705466 +0200
@@ -931,8 +931,10 @@
 
         if (!apr_table_get(headers_out, "Content-Type")
             && r->content_type) {
-            apr_table_setn(headers_out, "Content-Type",
-                           ap_make_content_type(r, r->content_type));
+            const char *ctype = ap_make_content_type(r, r->content_type);
+            if (ctype) {
+                apr_table_setn(headers_out, "Content-Type", ctype);
+            }
         }
 
         if (!apr_table_get(headers_out, "Content-Encoding")
--- a/modules/cache/mod_mem_cache.c.orig	2014-10-15 11:30:19.032171032 +0200
+++ b/modules/cache/mod_mem_cache.c	2014-10-15 11:33:08.468515018 +0200
@@ -632,8 +632,10 @@
     /* If not set in headers_out, set Content-Type */
     if (!apr_table_get(headers_out, "Content-Type")
         && r->content_type) {
-        apr_table_setn(headers_out, "Content-Type",
-                       ap_make_content_type(r, r->content_type));
+        const char *ctype = ap_make_content_type(r, r->content_type);
+        if (ctype) {
+            apr_table_setn(headers_out, "Content-Type", ctype);
+        }
     }
 
     if (!apr_table_get(headers_out, "Content-Encoding")
