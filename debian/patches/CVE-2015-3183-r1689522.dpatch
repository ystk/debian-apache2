#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2015-3183-r1689522.dpatch by  <santiagorr@riseup.net>
##
## DP: Fix CVE-2015-3183 (4/4 patches) as 2015-07-18
## DP: Origin: upstream, svn diff --git --patch-compatible -c 1689522 http://svn.apache.org/repos/asf/httpd/httpd/branches/2.2.x

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' apache2~/modules/http/http_filters.c apache2/modules/http/http_filters.c
--- apache2~/modules/http/http_filters.c	2015-07-18 15:52:18.000000000 +0200
+++ apache2/modules/http/http_filters.c	2015-07-18 15:52:19.000000000 +0200
@@ -62,6 +62,7 @@
     apr_off_t limit;
     apr_off_t limit_used;
     apr_int32_t chunk_used;
+    apr_int32_t chunk_bws;
     apr_int32_t chunkbits;
     enum
     {
@@ -157,6 +158,7 @@
             ctx->remaining = 0;
             ctx->chunkbits = sizeof(apr_off_t) * 8;
             ctx->chunk_used = 0;
+            ctx->chunk_bws = 0;
         }
 
         if (c == LF) {
@@ -188,7 +190,12 @@
             }
         }
         else if (c == ' ' || c == '\t') {
+            /* Be lenient up to 10 BWS (term from rfc7230 - 3.2.3).
+             */
             ctx->state = BODY_CHUNK_CR;
+            if (++ctx->chunk_bws > 10) {
+                return APR_EINVAL;
+            }
         }
         else if (ctx->state == BODY_CHUNK_CR) {
             /*
@@ -451,6 +458,7 @@
         case BODY_CHUNK:
         case BODY_CHUNK_PART:
         case BODY_CHUNK_EXT:
+        case BODY_CHUNK_CR:
         case BODY_CHUNK_LF:
         case BODY_CHUNK_END:
         case BODY_CHUNK_END_LF: {
