#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2015-3183-r1687339.dpatch by  <santiagorr@riseup.net>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Fix CVE-2015-3183 (2/4 patches) as 2015-07-18
## DP: Origin: upstream, svn diff --git --patch-compatible -c 1687339 http://svn.apache.org/repos/asf/httpd/httpd/branches/2.2.x


@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' apache2~/modules/http/http_filters.c apache2/modules/http/http_filters.c
--- apache2~/modules/http/http_filters.c	2015-07-18 15:51:34.000000000 +0200
+++ apache2/modules/http/http_filters.c	2015-07-18 15:51:34.000000000 +0200
@@ -70,10 +70,11 @@
         BODY_CHUNK, /* chunk expected */
         BODY_CHUNK_PART, /* chunk digits */
         BODY_CHUNK_EXT, /* chunk extension */
-        BODY_CHUNK_LF, /* got CR, expect LF after digits/extension */
+        BODY_CHUNK_CR, /* got space(s) after digits, expect [CR]LF or ext */
+        BODY_CHUNK_LF, /* got CR after digits or ext, expect LF */
         BODY_CHUNK_DATA, /* data constrained by chunked encoding */
         BODY_CHUNK_END, /* chunked data terminating CRLF */
-        BODY_CHUNK_END_LF, /* got CR, expect LF after data */
+        BODY_CHUNK_END_LF, /* got CR after data, expect LF */
         BODY_CHUNK_TRAILER /* trailers */
     } state;
     unsigned int eos_sent :1;
@@ -186,6 +187,15 @@
                 return APR_EINVAL;
             }
         }
+        else if (c == ' ' || c == '\t') {
+            ctx->state = BODY_CHUNK_CR;
+        }
+        else if (ctx->state == BODY_CHUNK_CR) {
+            /*
+             * ';', CR or LF expected.
+             */
+            return APR_EINVAL;
+        }
         else if (ctx->state == BODY_CHUNK_PART) {
             int xvalue;
 
